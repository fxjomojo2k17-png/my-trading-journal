<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trading Journal PRO</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üíª</text></svg>">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* BASE DESIGN */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #0b0e11; 
            min-height: 100vh;
            padding: 10px;
            color: #e0e0e0;
            overflow-x: hidden;
            transition: transform 0.1s ease-out;
            position: relative;
        }
		
/* Custom Neon Checkbox */
.trade-checkbox, #selectAll {
    appearance: none; /* Entfernt den Standard-Browser-Look */
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    border: 2px solid #764ba2; /* Dein Lila-Ton */
    border-radius: 3px;
    background: rgba(118, 75, 162, 0.1);
    cursor: pointer;
    position: relative;
    vertical-align: middle;
    transition: all 0.2s ease;
    outline: none;
}

/* Effekt beim Dr√ºberfahren (Hover) */
.trade-checkbox:hover, #selectAll:hover {
    border-color: #00f2ff; /* Neon-Cyan beim Hover */
    box-shadow: 0 0 8px rgba(0, 242, 255, 0.5);
}

/* Wenn die Checkbox markiert ist */
.trade-checkbox:checked, #selectAll:checked {
    background-color: #764ba2;
    border-color: #00f2ff;
    box-shadow: 0 0 10px rgba(118, 75, 162, 0.8);
}

/* Das H√§kchen-Symbol (wei√ües V) */
.trade-checkbox:checked::after, #selectAll:checked::after {
    content: '‚úî';
    position: absolute;
    color: white;
    font-size: 10px;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

/* Die erste Spalte fixieren */
.trades-table th:first-child, 
.trades-table td:first-child {
    width: 40px;
    text-align: center;
}


.btn-delete-selected { background: #ffa726; color: white; border: none; border-radius: 4px; padding: 0 12px; height: 32px; font-size: 0.7em; font-weight: bold; cursor: pointer; margin-right: 10px; }
		
		
		/* AUTO SYNC STYLES */
.mt-integration-box {
    background: rgba(22, 26, 30, 0.6);
    border: 1px solid rgba(118, 75, 162, 0.3);
    border-radius: 12px;
    padding: 30px;
    margin-bottom: 30px;
}
.mt-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;
}
.mt-card {
    background: rgba(37, 45, 55, 0.8); padding: 20px; border-radius: 10px; text-align: center;
    border: 1px solid rgba(255, 255, 255, 0.05); transition: transform 0.3s ease;
}
.mt-card:hover { transform: translateY(-5px); border-color: #00f2ff; }
.mt-icon {
    width: 50px; height: 50px; background: #fff; color: #000; font-weight: bold; font-size: 24px;
    border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px auto;
}
.mt-icon.mt5 { background: #00f2ff; }
.btn-download {
    display: inline-block; padding: 8px 16px; background: transparent; border: 1px solid #764ba2;
    color: #fff; text-decoration: none; border-radius: 4px; font-size: 0.85em; margin-top: 10px;
}
.btn-download:hover { background: #764ba2; }

.api-credentials-box {
    background: #0f1216; border: 1px solid #333; padding: 20px; border-radius: 8px; margin-bottom: 20px;
}
.credential-row { margin-bottom: 12px; }
.credential-row label { display: block; color: #888; font-size: 0.75em; margin-bottom: 4px; text-transform: uppercase; }
.copy-input { display: flex; gap: 8px; }
.copy-input input {
    flex: 1; background: #1a1d21 !important; border: 1px solid #333 !important; color: #00ffaa !important;
    font-family: monospace; font-size: 13px; padding: 8px; border-radius: 4px;
}
.copy-input button {
    background: #333; color: white; border: none; padding: 0 12px; border-radius: 4px; cursor: pointer; font-size: 0.8em;
}
.copy-input button:hover { background: #555; }
.mt-instructions { background: rgba(0,242,255,0.05); padding: 15px; border-radius: 6px; border-left: 2px solid #00f2ff; }
.mt-instructions h4 { color: #00f2ff; margin-bottom: 5px; font-size: 0.9em; }
.mt-instructions ol { padding-left: 20px; color: #aaa; font-size: 0.85em; line-height: 1.6; }
.mt-instructions b { color: #e0e0e0; }
		
		
		/* LOGIN SCREEN */
        #loginScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(11, 14, 17, 0.3) 0%, rgba(26, 31, 38, 0.5) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .login-box {
            background: rgba(22, 26, 30, 0.95);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.7);
            border: 1px solid rgba(118, 75, 162, 0.4);
            max-width: 400px;
            width: 90%;
            backdrop-filter: blur(15px);
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-box h2 {
            color: #00f2ff;
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.8em;
            text-shadow: 0 0 15px rgba(0, 242, 255, 0.5);
            letter-spacing: 2px;
        }

        .login-form .form-group {
            margin-bottom: 20px;
        }

        .login-form label {
            display: block;
            margin-bottom: 8px;
            color: #8892b0;
            font-size: 0.9em;
            text-transform: uppercase;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .login-form input {
            width: 100%;
            padding: 12px;
            background: rgba(37, 45, 55, 0.8);
            border: 1px solid #3d4651;
            border-radius: 6px;
            color: white;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .login-form input:focus {
            border-color: #00f2ff;
            box-shadow: 0 0 10px rgba(0, 242, 255, 0.4);
            outline: none;
            background: rgba(45, 55, 65, 0.9);
        }

        .login-form button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #764ba2, #667eea);
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .login-form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(118, 75, 162, 0.4);
        }

        .login-form button:active {
            transform: translateY(0);
        }

        .login-toggle {
            text-align: center;
            margin-top: 20px;
            color: #8892b0;
            font-size: 0.9em;
        }

        .login-toggle a {
            color: #00f2ff;
            text-decoration: none;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        .login-toggle a:hover {
            text-decoration: underline;
            text-shadow: 0 0 8px rgba(0, 242, 255, 0.5);
        }

        .error-message, .success-message {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 0.9em;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .error-message {
            background: rgba(255, 74, 104, 0.2);
            border: 1px solid #ff4a68;
            color: #ff4a68;
        }

        .success-message {
            background: rgba(0, 255, 170, 0.2);
            border: 1px solid #00ffaa;
            color: #00ffaa;
        }

        .user-info {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(37, 45, 55, 0.8);
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid rgba(118, 75, 162, 0.4);
            backdrop-filter: blur(5px);
        }

        .user-info span {
            color: #00f2ff;
            font-weight: bold;
            font-size: 14px;
        }

        .btn-logout {
            background: #ff4a68;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: 0.2s;
        }

        .btn-logout:hover {
            background: #ff3050;
            transform: translateY(-1px);
        }
		
		

        /* ANIMATED BACKGROUND CANVAS */
        #bgCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; 
            pointer-events: none;
        }
		
		
		

        /* Glitch Class */

/* Glitch Classes f√ºr Win/Loss/BE */
.glitch-win {
    animation: glitchShake 0.2s ease-in-out;
}

.glitch-loss {
    animation: glitchShake 0.2s ease-in-out;
}

.glitch-be {
    animation: glitchShake 0.15s ease-in-out;
}

@keyframes glitchShake {
    0% { transform: translate(0); }
    20% { transform: translate(-2px, 2px); }
    40% { transform: translate(-2px, -2px); }
    60% { transform: translate(2px, 2px); }
    80% { transform: translate(2px, -2px); }
    100% { transform: translate(0); }
}

/* Flash Overlay */
#flashOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 9999;
    opacity: 0;
}

#flashOverlay.flash-win {
    background: rgba(0, 255, 170, 0.3);
    opacity: 1;
}

#flashOverlay.flash-loss {
    background: rgba(255, 74, 104, 0.35);
    opacity: 1;
}

#flashOverlay.flash-be {
    background: rgba(118, 75, 162, 0.25);
    opacity: 1;
}

/* Shake Animation */
.shake-win, .shake-loss, .shake-be {
    animation: shake 0.2s ease-in-out;
}

@keyframes shake {
    0%, 100% { transform: translate(0); }
    25% { transform: translate(-3px, 3px); }
    50% { transform: translate(3px, -3px); }
    75% { transform: translate(-3px, -3px); }
}
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(22, 26, 30, 0.85) !important;
            backdrop-filter: blur(15px);
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.7);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.08);
            position: relative;
        }

/* REALISTIC CANDLESTICK CHART DIVIDER */
.section-divider {
    height: 55px;
    margin: 40px auto;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
    max-width: 900px;
    width: 90%;
    background: transparent;
    border: none;
}

.section-divider::before {
    content: '';
    width: 100%;
    height: 100%;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="220" height="55" viewBox="0 0 220 55" preserveAspectRatio="none"><defs><filter id="glow-green"><feGaussianBlur stdDeviation="1.2" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter><filter id="glow-red"><feGaussianBlur stdDeviation="1.2" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs><g filter="url(%23glow-green)" opacity="0.5"><line x1="10" y1="25" x2="10" y2="12" stroke="%2300ffaa" stroke-width="1.2" stroke-linecap="round"/><rect x="7" y="18" width="6" height="10" fill="%2300ffaa" stroke="%2300ffaa" stroke-width="0.5" rx="0.5"/><line x1="10" y1="28" x2="10" y2="38" stroke="%2300ffaa" stroke-width="1.2" stroke-linecap="round"/></g><g filter="url(%23glow-green)" opacity="0.5"><line x1="25" y1="20" x2="25" y2="10" stroke="%2300ffaa" stroke-width="1.2" stroke-linecap="round"/><rect x="22" y="15" width="6" height="12" fill="%2300ffaa" stroke="%2300ffaa" stroke-width="0.5" rx="0.5"/><line x1="25" y1="27" x2="25" y2="35" stroke="%2300ffaa" stroke-width="1.2" stroke-linecap="round"/></g><g filter="url(%23glow-green)" opacity="0.5"><line x1="40" y1="18" x2="40" y2="8" stroke="%2300ffaa" stroke-width="1.2" stroke-linecap="round"/><rect x="37" y="12" width="6" height="14" fill="%2300ffaa" stroke="%2300ffaa" stroke-width="0.5" rx="0.5"/><line x1="40" y1="26" x2="40" y2="40" stroke="%2300ffaa" stroke-width="1.2" stroke-linecap="round"/></g><g filter="url(%23glow-red)" opacity="0.5"><line x1="55" y1="22" x2="55" y2="15" stroke="%23ff4a68" stroke-width="1.2" stroke-linecap="round"/><rect x="52" y="22" width="6" height="8" fill="%23ff4a68" stroke="%23ff4a68" stroke-width="0.5" rx="0.5"/><line x1="55" y1="30" x2="55" y2="38" stroke="%23ff4a68" stroke-width="1.2" stroke-linecap="round"/></g><g filter="url(%23glow-red)" opacity="0.5"><line x1="70" y1="24" x2="70" y2="18" stroke="%23ff4a68" stroke-width="1.2" stroke-linecap="round"/><rect x="67" y="24" width="6" height="9" fill="%23ff4a68" stroke="%23ff4a68" stroke-width="0.5" rx="0.5"/><line x1="70" y1="33" x2="70" y2="40" stroke="%23ff4a68" stroke-width="1.2" stroke-linecap="round"/></g><g filter="url(%23glow-green)" opacity="0.5"><line x1="85" y1="15" x2="85" y2="5" stroke="%2300ffaa" stroke-width="1.2" stroke-linecap="round"/><rect x="82" y="10" width="6" height="16" fill="%2300ffaa" stroke="%2300ffaa" stroke-width="0.5" rx="0.5"/><line x1="85" y1="26" x2="85" y2="42" stroke="%2300ffaa" stroke-width="1.2" stroke-linecap="round"/></g><g filter="url(%23glow-green)" opacity="0.5"><line x1="100" y1="12" x2="100" y2="6" stroke="%2300ffaa" stroke-width="1.2" stroke-linecap="round"/><rect x="97" y="10" width="6" height="14" fill="%2300ffaa" stroke="%2300ffaa" stroke-width="0.5" rx="0.5"/><line x1="100" y1="24" x2="100" y2="36" stroke="%2300ffaa" stroke-width="1.2" stroke-linecap="round"/></g><g filter="url(%23glow-red)" opacity="0.5"><line x1="115" y1="20" x2="115" y2="14" stroke="%23ff4a68" stroke-width="1.2" stroke-linecap="round"/><rect x="112" y="20" width="6" height="10" fill="%23ff4a68" stroke="%23ff4a68" stroke-width="0.5" rx="0.5"/><line x1="115" y1="30" x2="115" y2="38" stroke="%23ff4a68" stroke-width="1.2" stroke-linecap="round"/></g><g filter="url(%23glow-red)" opacity="0.5"><line x1="130" y1="22" x2="130" y2="16" stroke="%23ff4a68" stroke-width="1.2" stroke-linecap="round"/><rect x="127" y="22" width="6" height="11" fill="%23ff4a68" stroke="%23ff4a68" stroke-width="0.5" rx="0.5"/><line x1="130" y1="33" x2="130" y2="42" stroke="%23ff4a68" stroke-width="1.2" stroke-linecap="round"/></g><g filter="url(%23glow-green)" opacity="0.5"><line x1="145" y1="20" x2="145" y2="12" stroke="%2300ffaa" stroke-width="1.2" stroke-linecap="round"/><rect x="142" y="16" width="6" height="10" fill="%2300ffaa" stroke="%2300ffaa" stroke-width="0.5" rx="0.5"/><line x1="145" y1="26" x2="145" y2="36" stroke="%2300ffaa" stroke-width="1.2" stroke-linecap="round"/></g><g filter="url(%23glow-green)" opacity="0.5"><line x1="160" y1="18" x2="160" y2="8" stroke="%2300ffaa" stroke-width="1.2" stroke-linecap="round"/><rect x="157" y="12" width="6" height="14" fill="%2300ffaa" stroke="%2300ffaa" stroke-width="0.5" rx="0.5"/><line x1="160" y1="26" x2="160" y2="38" stroke="%23ff4a68" stroke-width="1.2" stroke-linecap="round"/></g><g filter="url(%23glow-green)" opacity="0.5"><line x1="175" y1="22" x2="175" y2="14" stroke="%2300ffaa" stroke-width="1.2" stroke-linecap="round"/><rect x="172" y="18" width="6" height="11" fill="%2300ffaa" stroke="%2300ffaa" stroke-width="0.5" rx="0.5"/><line x1="175" y1="29" x2="175" y2="40" stroke="%2300ffaa" stroke-width="1.2" stroke-linecap="round"/></g><g filter="url(%23glow-red)" opacity="0.5"><line x1="190" y1="24" x2="190" y2="18" stroke="%23ff4a68" stroke-width="1.2" stroke-linecap="round"/><rect x="187" y="24" width="6" height="8" fill="%23ff4a68" stroke="%23ff4a68" stroke-width="0.5" rx="0.5"/><line x1="190" y1="32" x2="190" y2="40" stroke="%23ff4a68" stroke-width="1.2" stroke-linecap="round"/></g><g filter="url(%23glow-green)" opacity="0.5"><line x1="205" y1="20" x2="205" y2="10" stroke="%2300ffaa" stroke-width="1.2" stroke-linecap="round"/><rect x="202" y="14" width="6" height="13" fill="%2300ffaa" stroke="%2300ffaa" stroke-width="0.5" rx="0.5"/><line x1="205" y1="27" x2="205" y2="38" stroke="%2300ffaa" stroke-width="1.2" stroke-linecap="round"/></g></svg>');
    background-repeat: repeat-x;
    background-position: center;
    background-size: auto 100%;
    opacity: 0.65;
    filter: drop-shadow(0 0 2px rgba(0, 242, 255, 0.15)) drop-shadow(0 0 4px rgba(118, 75, 162, 0.1));
}

.section-divider:hover::before {
    opacity: 0.8;
    filter: drop-shadow(0 0 3px rgba(0, 242, 255, 0.2)) drop-shadow(0 0 5px rgba(118, 75, 162, 0.15));
}

        .user-switcher {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(37, 45, 55, 0.8);
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid rgba(118, 75, 162, 0.4);
            backdrop-filter: blur(5px);
        }
        .user-switcher select { 
            background: transparent; border: none; color: white;
            font-weight: bold; cursor: pointer; height: auto; width: auto; font-size: 14px;
        }
        
		
        .header {
            background-color: #0b0e11;
            /* background-image: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.9)), 
                              url('https://images.unsplash.com/photo-1590283603385-17ffb3a7f29f?auto=format&fit=crop&q=80&w=1200'); */
            background-size: cover;
            background-position: center;
            padding: 40px 15px 30px 15px;
            text-align: center;
            border-bottom: 3px solid #764ba2;
        }

        .header h1 { font-size: 1.5em; letter-spacing: 1px; text-transform: uppercase; color: #00f2ff; text-shadow: 0 0 15px rgba(0, 242, 255, 0.5); }

 /* MOCKUP 5: Animated Candle Chart */
        .candle-chart-text {
            position: relative;
            font-size: 2em;
            font-weight: bold;
            letter-spacing: 8px;
            color: #00f2ff;
            text-shadow: 0 0 20px rgba(0, 242, 255, 0.8);
        }

        .chart-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60%;
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            opacity: 0.4;
            gap: 4px;
            padding: 0 10%;
        }

        .mini-candle {
            width: 6px;
            background: linear-gradient(to bottom, transparent, #00ffaa);
            border: 1px solid #00ffaa;
            animation: growCandle 1.5s ease-in-out infinite;
        }

        .mini-candle:nth-child(even) {
            background: linear-gradient(to bottom, transparent, #ff4a68);
            border-color: #ff4a68;
            animation-delay: -0.5s;
        }

        @keyframes growCandle {
            0%, 100% { transform: scaleY(0.5); }
            50% { transform: scaleY(1); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 10px;
            padding: 15px;
            background: rgba(28, 34, 41, 0.6);
        }
        
        .stat-card {
            background: rgba(37, 45, 55, 0.7);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-left: 3px solid #764ba2;
            transition: all 0.4s ease;
        }

        .glow-win { box-shadow: 0 0 15px rgba(0, 255, 170, 0.2); border-color: rgba(0, 255, 170, 0.4); }
        .glow-loss { box-shadow: 0 0 15px rgba(255, 74, 104, 0.2); border-color: rgba(255, 74, 104, 0.4); }

        .stat-card h3 { color: #8892b0; font-size: 0.6em; text-transform: uppercase; margin-bottom: 5px; }
        .stat-card .value { font-size: 1.1em; font-weight: bold; }

        .form-section { padding: 20px; }
        
        .form-grid { 
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            align-items: end;
        }
        
        @media (min-width: 1024px) {
            .form-grid { grid-template-columns: repeat(12, 1fr); }
            .span-2 { grid-column: span 2; }
            .header h1 { font-size: 2.2em; }
            body { padding: 20px; }
        }

        .form-group { display: flex; flex-direction: column; width: 100%; }
        label { font-size: 0.65em; color: #8892b0; margin-bottom: 6px; text-transform: uppercase; font-weight: bold; }

        input, select, textarea {
            background: rgba(37, 45, 55, 0.8) !important; border: 1px solid #3d4651 !important;
            color: white !important; padding: 10px; border-radius: 6px; outline: none; width: 100%; font-size: 14px; height: 42px;
            transition: all 0.25s ease;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #00f2ff !important;
            box-shadow: 0 0 10px rgba(0, 242, 255, 0.4);
            background: rgba(45, 55, 65, 0.9) !important;
        }

        textarea#notes { height: 42px; width: 100%; resize: none; }

        .combo-container { display: flex; gap: 4px; height: 42px; align-items: center; width: 100%; }
        .btn-action { 
            background: #3d4651; color: white; width: 32px; height: 42px; 
            border-radius: 6px; border: none; cursor: pointer;
            font-size: 18px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
            transition: 0.2s;
        }
        .btn-add { background: #764ba2; }
        .btn-del { background: #4a5568; font-size: 22px; }

        .button-group { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .button-group button { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; transition: 0.3s; font-size: 0.75em; min-height: 38px; }
        
        .btn-primary { background: linear-gradient(135deg, #764ba2, #667eea); color: white; }
        .btn-secondary { background: #3d4651; color: white; }
        .btn-export { background: transparent !important; border: 1px solid #00f2ff !important; color: #00f2ff !important; padding: 0 12px; height: 32px; font-size: 0.7em; font-weight: bold; border-radius: 4px; cursor: pointer; }

       .charts-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; padding: 20px; }
.chart-box { background: rgba(37, 45, 55, 0.6); padding: 15px; border-radius: 12px; height: 320px; border: 1px solid rgba(255,255,255,0.05); }
.chart-box-wide { grid-column: 1 / -1; height: 450px; }

        .calendar-section { padding: 20px; max-width: 450px; margin: 0 auto; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; color: #8892b0; font-size: 0.75em; text-transform: uppercase; font-weight: bold; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; background: rgba(28, 34, 41, 0.6); padding: 8px; border-radius: 8px; }
        
        .calendar-day { background: rgba(37, 45, 55, 0.8); aspect-ratio: 1.2; border-radius: 4px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; font-size: 0.7em; border: 1px solid rgba(255,255,255,0.03); cursor: pointer; transition: 0.2s; }
        .calendar-day:hover { background: #2d343c; transform: translateY(-2px); }
        .calendar-day.selected { border-color: #764ba2; background: rgba(118, 75, 162, 0.2); }
        .calendar-day.today { border-color: #00f2ff; }
        .calendar-day .day-num { position: absolute; top: 2px; left: 3px; font-size: 0.6em; color: #5c6680; }
        .calendar-day .day-pl { font-weight: bold; font-size: 0.75em; margin-top: 4px; }

        .day-win { background: rgba(0, 255, 170, 0.2) !important; color: #00ffaa !important; border-color: rgba(0, 255, 170, 0.4) !important; box-shadow: inset 0 0 10px rgba(0, 255, 170, 0.1); }
        .day-loss { background: rgba(255, 74, 104, 0.2) !important; color: #ff4a68 !important; border-color: rgba(255, 74, 104, 0.4) !important; box-shadow: inset 0 0 10px rgba(255, 74, 104, 0.1); }

        .history-controls { padding: 0 20px 0 20px; display: flex; justify-content: flex-end; align-items: center; gap: 15px; flex-wrap: wrap; }
        #historyInstrumentFilter { width: 160px !important; }

        .btn-delete-all { background: #ef5350; color: white; border: none; border-radius: 4px; padding: 0 12px; height: 32px; font-size: 0.7em; font-weight: bold; cursor: pointer; }

        .trades-table { padding: 10px 20px 20px 20px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background: rgba(28, 34, 41, 0.85); color: #8892b0; padding: 12px; text-align: left; font-size: 0.7em; text-transform: uppercase; }
        
        tr { transition: all 0.2s ease; }
        tbody tr:hover { background: rgba(255, 255, 255, 0.05) !important; transform: scale(1.002); box-shadow: inset 4px 0 0 #764ba2; }
        
        td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.85em; }

        .win { color: #00ffaa !important; }
        .loss { color: #ff4a68 !important; }
        .btn-sm { padding: 6px 10px; font-size: 0.75em; border-radius: 4px; border: 1px solid transparent; cursor: pointer; margin-right: 5px; }
        .edit-btn { background: rgba(0, 242, 255, 0.1); border-color: #00f2ff; color: #00f2ff; }
        .del-btn { background: rgba(255, 74, 104, 0.1); border-color: #ff4a68; color: #ff4a68; }

        .import-section { background: rgba(28, 34, 41, 0.6); padding: 30px 20px; border-top: 1px solid rgba(255,255,255,0.05); }
        .import-textarea { width: 100%; height: 120px; background: #0b0e11 !important; border: 1px solid #3d4651; color: #00ffaa !important; font-family: 'Courier New', monospace; font-size: 12px; padding: 15px; border-radius: 8px; resize: none; margin-bottom: 15px; }

        #screenshot-preview-popup {
            position: fixed; display: none; z-index: 10000; top: 50%; left: 50%; transform: translate(-50%, -50%);
            max-width: 90vw; max-height: 85vh; border: 3px solid #764ba2; border-radius: 12px; box-shadow: 0 0 100px rgba(0,0,0,0.9);
            pointer-events: none; object-fit: contain; background: #0b0e11;
        }

        @media (max-width: 768px) {
            .trades-table table, .trades-table thead, .trades-table tbody, .trades-table th, .trades-table td, .trades-table tr { display: block; }
            .trades-table tr { border: 1px solid #2d343c; margin-bottom: 15px; border-radius: 10px; background: rgba(37, 45, 55, 0.6); padding: 10px; }
            .trades-table td { border: none; position: relative; padding-left: 50%; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.05); }
            .trades-table td:before { content: attr(data-label); position: absolute; left: 10px; width: 45%; text-align: left; font-weight: bold; color: #8892b0; text-transform: uppercase; font-size: 0.75em; }
        }
		
		.pagination-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    padding: 20px;
    margin-top: 20px;
}

.pagination-buttons {
    display: flex;
    align-items: center;
    gap: 15px;
}

.page-btn {
    background: rgba(118, 75, 162, 0.2);
    border: 1px solid #764ba2;
    color: white;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.8em;
    font-weight: bold;
    transition: all 0.3s ease;
    text-transform: uppercase;
}

.page-btn:hover:not(:disabled) {
    background: #764ba2;
    box-shadow: 0 0 10px rgba(118, 75, 162, 0.5);
    border-color: #00f2ff;
}

.page-btn:disabled {
    opacity: 0.2;
    cursor: not-allowed;
    border-color: #444;
}

#pageInfo {
    font-size: 0.9em;
    color: #e0e0e0;
    font-family: monospace;
}

#tradeCounter {
    font-size: 0.75em;
    color: #00f2ff; /* Neon Cyan */
    opacity: 0.8;
    letter-spacing: 1px;
}

/* Dezenter Zeilen-Schimmer */
tr.row-win {
    background: linear-gradient(90deg, rgba(0, 255, 135, 0.05) 0%, rgba(0, 0, 0, 0) 100%);
}

tr.row-loss {
    background: linear-gradient(90deg, rgba(255, 82, 82, 0.05) 0%, rgba(0, 0, 0, 0) 100%);
}

/* Hover-Effekt verst√§rken f√ºr bessere Lesbarkeit */
.trades-table tbody tr:hover {
    background: rgba(255, 255, 255, 0.05) !important;
}
    </style>
</head>
<body>

<canvas id="bgCanvas"></canvas>

<img id="screenshot-preview-popup" src="" alt="Preview">

<!-- LOGIN SCREEN -->
<div id="loginScreen">
    <div class="login-box">
        <h2>üîê TRADING JOURNAL</h2>
        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>
        
        <div id="loginForm" class="login-form">
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="loginEmail" placeholder="your@email.com" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
            </div>
            <button onclick="handleLogin()">Login</button>
            <div class="login-toggle">
                Don't have an account? <a onclick="toggleAuthMode()">Sign Up</a>
            </div>
        </div>
        
        <div id="signupForm" class="login-form" style="display:none;">
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="signupEmail" placeholder="your@email.com" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="signupPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
            </div>
            <button onclick="handleSignup()">Create Account</button>
            <div class="login-toggle">
                Already have an account? <a onclick="toggleAuthMode()">Login</a>
            </div>
        </div>
    </div>
</div>

<!-- MAIN APP (versteckt bis Login) -->
<div id="mainApp" style="display:none;">

<div class="container">
   <div class="user-info">
        <span id="userEmail"></span>
        <button class="btn-logout" onclick="handleLogout()">Logout</button>
    </div>

    <div class="header">
	<!-- MOCKUP 5 -->
        <div class="mockup-section">
            
        
            <div class="header-demo">
                <div style="position: relative; display: inline-block;">
                    <div class="chart-overlay">
                        <div class="mini-candle" style="height: 40px;"></div>
                        <div class="mini-candle" style="height: 60px;"></div>
                        <div class="mini-candle" style="height: 35px;"></div>
                        <div class="mini-candle" style="height: 70px;"></div>
                        <div class="mini-candle" style="height: 45px;"></div>
                        <div class="mini-candle" style="height: 55px;"></div>
                        <div class="mini-candle" style="height: 50px;"></div>
                        <div class="mini-candle" style="height: 65px;"></div>
                        <div class="mini-candle" style="height: 40px;"></div>
                        <div class="mini-candle" style="height: 58px;"></div>
                        <div class="mini-candle" style="height: 42px;"></div>
                        <div class="mini-candle" style="height: 68px;"></div>
                    </div>
            <div class="candle-chart-text">TRADING JOURNAL</div>
                </div>
            </div></div>
	</div>

    <div class="stats-grid">
        <div class="stat-card" id="card-balance">
            <h3>Initial Balance</h3>
            <input type="text" id="initialBalanceInput" onchange="updateStatsAndTable()" value="300" 
                   style="background: transparent !important; border: none !important; color: #e0e0e0 !important; font-size: 1.1em; font-weight: bold; text-align: center; height: auto; padding: 0;">
        </div>
        <div class="stat-card" id="card-equity"><h3>Current Equity</h3><div class="value" id="currentEquity">$0.00</div></div>
        <div class="stat-card" id="card-trades"><h3>Trades</h3><div class="value" id="totalTrades">0</div></div>
        <div class="stat-card" id="card-winrate"><h3>Win Rate</h3><div class="value" id="winRate">0%</div></div>
        <div class="stat-card" id="card-pl"><h3>P/L ($)</h3><div class="value" id="totalPL">$0.00</div></div>
        <div class="stat-card" id="card-avgr"><h3>Avg R</h3><div class="value" id="avgR">0.0R</div></div>
        <div class="stat-card" id="card-pf"><h3>Profit Factor</h3><div class="value" id="profitFactor">0.00</div></div>
		<div class="stat-card">
    <h3>Avg Win</h3>
    <div id="avgWin" class="value win">$0.00</div>
</div>
<div class="stat-card">
    <h3>Avg Loss</h3>
    <div id="avgLoss" class="value loss">$0.00</div>
</div>

    </div>

    <div class="form-section">
        <form id="tradeForm">
            <input type="hidden" id="editId" value="">
            <div class="form-grid">
                <div class="form-group"><label>Date</label><input type="date" id="date" required></div>
                <div class="form-group"><label>Time</label><input type="time" id="time" required></div>
                <div class="form-group span-2"><label>Instrument</label>
                    <div class="combo-container">
                        <select id="instrument" required></select>
                        <button type="button" class="btn-action btn-add" onclick="addNewInstrument()">+</button>
                        <button type="button" class="btn-action btn-del" onclick="removeInstrument()">‚Äì</button>
                    </div>
                </div>
                <div class="form-group span-2"><label>Strategy</label>
                    <div class="combo-container">
                        <select id="strategy" required></select>
                        <button type="button" class="btn-action btn-add" onclick="addNewStrategy()">+</button>
                        <button type="button" class="btn-action btn-del" onclick="removeStrategy()">‚Äì</button>
                    </div>
                </div>
                <div class="form-group"><label>Direction</label><select id="direction" required><option value="LONG">LONG</option><option value="SHORT">SHORT</option></select></div>
                <div class="form-group"><label>Entry</label><input type="text" id="entry" required oninput="validateNumber(this)"></div>
                <div class="form-group"><label>Exit</label><input type="text" id="exit" required oninput="validateNumber(this)"></div>
                <div class="form-group"><label>Result</label><select id="result" required><option value="WIN">Win</option><option value="LOSS">Loss</option><option value="BE">BE</option></select></div>
                <div class="form-group"><label>P/L ($)</label><input type="text" id="pl" required oninput="validateNumber(this)"></div>
                <div class="form-group"><label>Risk ($)</label><input type="text" id="risk" oninput="validateNumber(this)"></div>
                <div class="form-group"><label>Tag</label>
                    <select id="mistake">
                        <option value="PLAN">Per Plan</option>
                        <option value="FOMO">FOMO</option>
                        <option value="EARLY_EXIT">Early Exit</option>
                        <option value="REVENGE">Revenge</option>
                        <option value="LATE_ENTRY">Late Entry</option>
                        <option value="MISTAKE">Mistake</option>
                    </select>
                </div>
                <div class="form-group"><label>Screenshot</label><input type="text" id="screenshot" placeholder="Link or drag file..."></div>
                <div class="form-group span-2"><label>Notes</label><textarea id="notes" rows="1" placeholder="Details..."></textarea></div>
            </div>
            <div class="button-group">
                <button type="submit" id="submitBtn" class="btn-primary">Save Trade</button>
                <button type="button" class="btn-secondary" onclick="resetForm()">Cancel</button>
            </div>
        </form>
    </div>

    <div class="section-divider"></div>

  <div class="charts-container">
    <div class="chart-box"><canvas id="equityChart"></canvas></div>
    <div class="chart-box"><canvas id="drawdownChart"></canvas></div>
    <div class="chart-box"><canvas id="strategyPLChart"></canvas></div>
    <div class="chart-box"><canvas id="distributionChart"></canvas></div>
    <div class="chart-box"><canvas id="weekdayChart"></canvas></div>
	<!--	<div class="chart-box" ><canvas id="avgChart"></canvas></div> -->
	
    <div class="chart-box chart-box-wide"><canvas id="heatmapChart"></canvas></div>


</div>

    <div class="section-divider"></div>

    <div class="calendar-section">
        <div class="calendar-header">
            <span id="calendarMonth">Month</span>
            <div style="display:flex; gap:5px;"><button class="btn-sm edit-btn" onclick="changeMonth(-1)">‚Üê</button><button class="btn-sm edit-btn" onclick="changeMonth(1)">‚Üí</button></div>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
    </div>

    <div class="history-controls">
        <label>Filter Instrument:</label>
        <select id="historyInstrumentFilter" onchange="updateStatsAndTable()"><option value="ALL">All Instruments</option></select>
        <button type="button" onclick="deleteSelectedTrades()" class="btn-delete-selected">Delete Selected</button>
		<button type="button" class="btn-export" onclick="exportToCSV()">Export CSV</button>
        <button type="button" onclick="deleteAllTrades()" class="btn-delete-all">Delete All Trades</button>
    </div>

    <div class="trades-table">
        <table>
            <thead><tr>
			
			<th><input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)"></th>
			
			<th>Date</th><th>Inst.</th><th>Strategy</th><th>Dir</th><th>Entry/Exit</th><th>P/L ($)</th><th>R</th><th>Tag</th><th>IMG</th><th>Action</th></tr></thead>
            <tbody id="tradesBody"></tbody>
        </table>
    </div>
<div class="pagination-container">
    <div id="tradeCounter">Showing 0-0 of 0 Trades</div>
    <div class="pagination-buttons">
        <button class="page-btn" id="prevPage" onclick="changePage(-1)">‚Üê Prev</button>
        <span id="pageInfo">Page 1 of 1</span>
        <button class="page-btn" id="nextPage" onclick="changePage(1)">Next ‚Üí</button>
    </div>
</div>
<div class="section-divider"></div>	

<div class="import-section">

  <div class="import-container">
            <h3 style="margin-bottom:10px; color:#00f2ff;">Import copy and paste</h3>
            <textarea id="importArea" class="import-textarea" placeholder="Paste broker (Tradingview export the data u find under Balance-History) history here..."></textarea>
            <button onclick="processBulkImport()" class="btn-primary" style="width:15%; padding:12px; border-radius:8px; border:none; cursor:pointer; font-weight:bold;">Import Trades Now</button>
        </div><br><br>


    <div class="container-narrow" style="max-width: 900px; margin: 0 auto;">
        
        <div class="mt-integration-box">
            <h2 style="color: #fff; text-align: center; margin-bottom: 30px; letter-spacing: 2px;">
                <span style="color: #00f2ff;">METATRADER</span> AUTO-SYNC
            </h2>

            <div class="mt-grid">
			
			<div class="mt-card" style="opacity: 0.7;">
    <div class="mt-icon" style="background: #555;">4</div>
    <h3>MetaTrader 4</h3>
    <p style="font-size:0.8em; color:#aaa; margin-bottom:10px;">Auto-Sync Script</p>
    
	
	<span class="btn-download" 
          style="background: #444; color: #888; cursor: not-allowed; border: 1px dashed #666; display: inline-block; padding: 10px 20px; text-decoration: none; border-radius: 5px;" 
          title="Currently under development">
        Under Development
    </span>
</div>
			
			<!--
                <div class="mt-card">
                    <div class="mt-icon">4</div>
                    <h3>MetaTrader 4</h3>
                    <p style="font-size:0.8em; color:#aaa; margin-bottom:10px;">Auto-Sync Script</p>
                    <a href="JournalSync_MT4.mq4" download class="btn-download">Download .mq4</a>
                </div>
				-->
				
				
				
                <div class="mt-card">
                    <div class="mt-icon mt5">5</div>
                    <h3>MetaTrader 5</h3>
                    <p style="font-size:0.8em; color:#aaa; margin-bottom:10px;">Auto-Sync Script</p>
                    <button onclick="downloadPersonalizedEA()" download class="btn-download">Download .mq5</a>
	
                </div>
            </div>
			

            <div class="section-divider" style="margin: 20px auto; opacity:0.3;"></div>

           <!-- <div class="api-credentials-box">
                <h4 style="color:#00f2ff; margin-bottom:15px; border-bottom:1px solid #444; padding-bottom:10px;">
                     Sync Settings
                </h4>	-->


                <div class="credential-row" style="display: none;">
                    <label>User ID:</label>
                    <div class="copy-input">
                        <input type="text" id="disp_uid" readonly placeholder="Login first...">
                        <button onclick="copyToClip('disp_uid')">Copy</button>
                    </div>
                </div>
            <!-- </div> 	-->

            <div class="mt-instructions">
			
<!-- <div style="background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 20px; color: #e6edf3; font-family: sans-serif; line-height: 1.6;"> -->
    
	<h1 style="color: #00f2ff; border-bottom: 1px solid #30363d; padding-bottom: 10px;">MT5 Auto-Sync Setup</h1>
    
    <ol style="padding-left: 20px; margin-top: 15px;">
        <li><strong>Download:</strong> Click the button above to get your personalized <code>.mq5</code> file. Your User-ID is already included.</li>
        <li><strong>Locate Folder:</strong> Open MetaTrader 5, go to <code>File > Open Data Folder</code>, then navigate to <code>MQL5 > Experts</code>.</li>
        <li><strong>Copy File:</strong> Paste the downloaded file into the <code>Experts</code> folder.</li>
        <li><strong>Enable WebRequest:</strong> Go to <code>Tools > Options > Expert Advisors</code>.
            <ul style="list-style-type: circle; padding-left: 20px; margin-top: 5px; color: #8b949e;">
                <li>Check "Allow WebRequest for listed URL"</li>
                <li>Add: <code>https://nrmivhzvwqpnwedvkbbz.supabase.co</code></li>
            </ul>
        </li>
        <li><strong>Activate:</strong> In MT5 Navigator, right-click <code>Experts > Refresh</code>. Drag the script onto any chart and ensure "Algo Trading" is enabled at the top.</li>
      </ol>
	  
	  
<!-- </div> -->


            </div>
        </div>

    </div>
</div>
</div>

<script>
let currentPage = 1;
const tradesPerPage = 25;


    /* ANIMATED CYBER BACKGROUND */
    const canvas = document.getElementById('bgCanvas');
    const ctx = canvas.getContext('2d');
    let elements = [];
    let mouseTrail = [];
    let mouse = { x: -100, y: -100 };

    const formulas = [
        "RR = (Exit - Entry) / (Entry - SL)", "P/L = Lot √ó (pips √ó value)", 
        "0.618 (Golden Ratio)", "0.618 Retracement", "EV = (W% √ó AvgW) - (L% √ó AvgL)", "Market Profile", 
        "Value Area", "Fair Value", "Volume", "Breakout", "Smart Money Concepts", "Engulfing", "‚àë(x - Œº)¬≤",
        "Profit", "Margin Call", "Candlestick Pattern"
    ];

    function initCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }

    class FallingElement {
        constructor(type) {
            this.type = type; 
            this.reset();
        }
        reset() {
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * -canvas.height;
            this.speed = 0.4 + Math.random() * 1.2;
            
            if (this.type === 'candle') {
                this.opacity = 0.2 + Math.random() * 0.15;
                this.width = 3 + Math.random() * 5;
                this.height = 10 + Math.random() * 30;
                this.isBullish = Math.random() > 0.5;
            } else {
                this.opacity = 1.2 + Math.random() * 0.4;
                this.text = formulas[Math.floor(Math.random() * formulas.length)];
                this.fontSize = 11 + Math.random() * 7;
            }
        }
        update() {
            this.y += this.speed;
            if (this.y > canvas.height) this.reset();
        }
        draw() {
            if (this.type === 'candle') {
                ctx.strokeStyle = this.isBullish ? `rgba(0, 255, 170, ${this.opacity})` : `rgba(255, 74, 104, ${this.opacity})`;
                ctx.fillStyle = this.isBullish ? `rgba(0, 255, 170, ${this.opacity * 0.3})` : `rgba(255, 74, 104, ${this.opacity * 0.3})`;
                ctx.lineWidth = 1;
                ctx.beginPath(); ctx.moveTo(this.x + this.width/2, this.y - 4); ctx.lineTo(this.x + this.width/2, this.y + this.height + 4); ctx.stroke();
                ctx.fillRect(this.x, this.y, this.width, this.height); ctx.strokeRect(this.x, this.y, this.width, this.height);
            } else {
                ctx.fillStyle = `rgba(0, 242, 255, ${this.opacity})`;
                ctx.font = `bold ${this.fontSize}px 'Courier New', monospace`;
                ctx.fillText(this.text, this.x, this.y);
            }
        }
    }

    class MouseCandle {
        constructor(x, y) {
            this.x = x; this.y = y;
            this.opacity = 0.6;
            this.isBullish = Math.random() > 0.5;
        }
        update() { this.opacity -= 0.02; }
        draw() {
            ctx.strokeStyle = this.isBullish ? `rgba(0, 255, 170, ${this.opacity})` : `rgba(255, 74, 104, ${this.opacity})`;
            ctx.strokeRect(this.x - 2, this.y - 7.5, 4, 15);
        }
    }

    function drawNeuralLines() {
        ctx.lineWidth = 0.5;
        for (let i = 0; i < elements.length; i++) {
            for (let j = i + 1; j < elements.length; j++) {
                let dx = elements[i].x - elements[j].x;
                let dy = elements[i].y - elements[j].y;
                let dist = Math.sqrt(dx * dx + dy * dy);
                if (dist < 100) {
                    ctx.strokeStyle = `rgba(118, 75, 162, ${0.1 * (1 - dist/100)})`;
                    ctx.beginPath(); ctx.moveTo(elements[i].x, elements[i].y); ctx.lineTo(elements[j].x, elements[j].y); ctx.stroke();
                }
            }
        }
    }

    function setupBG() {
        elements = [
            ...Array.from({ length: 70 }, () => new FallingElement('candle')),
            ...Array.from({ length: 25 }, () => new FallingElement('formula'))
        ];
        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawNeuralLines();
            elements.forEach(e => { e.update(); e.draw(); });
            mouseTrail.forEach((mc, i) => {
                mc.update(); mc.draw();
                if (mc.opacity <= 0) mouseTrail.splice(i, 1);
            });
            requestAnimationFrame(animate);
        }
        animate();
    }

    window.addEventListener('mousemove', (e) => {
        mouse.x = e.clientX; mouse.y = e.clientY;
        if (Math.random() > 0.7) mouseTrail.push(new MouseCandle(mouse.x, mouse.y));
    });

    window.addEventListener('resize', initCanvas);
    initCanvas();
    setupBG();

    /* LOGIC */
    const SUPABASE_URL = 'https://nrmivhzvwqpnwedvkbbz.supabase.co'; 
    const SUPABASE_KEY = 'sb_publishable_-fh0VxK2T7Jy2M80qVI9fA_IkyVO_U2'; 
    const { createClient } = supabase;
    const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;

    // Auth Funktionen
async function checkAuth() {
    const { data: { session } } = await _supabase.auth.getSession();
    if (session) {
        currentUser = session.user;
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        document.getElementById('userEmail').textContent = currentUser.email;
        const uidInput = document.getElementById('disp_uid');
        if(uidInput) uidInput.value = currentUser.id;
		
		
        // Initialisiere alle wichtigen Funktionen
        populateLists();
        fetchTrades();
    } else {
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('mainApp').style.display = 'none';
    }
}

function copyToClip(id) {
    const el = document.getElementById(id);
    el.select();
    el.setSelectionRange(0, 99999); // F√ºr Mobile
    navigator.clipboard.writeText(el.value).then(() => {
        alert("Copied!");
    });
}


    async function handleLogin() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        
        const { data, error } = await _supabase.auth.signInWithPassword({
            email: email,
            password: password
        });
        
        if (error) {
            showError(error.message);
        } else {
            checkAuth();
        }
    }

    async function handleSignup() {
        const email = document.getElementById('signupEmail').value;
        const password = document.getElementById('signupPassword').value;
        
        if (password.length < 6) {
            showError('Password must be at least 6 characters');
            return;
        }
        
        const { data, error } = await _supabase.auth.signUp({
            email: email,
            password: password
        });
        
        if (error) {
            showError(error.message);
        } else {
            showSuccess('Account created! Please check your email to verify.');
        }
    }

    async function handleLogout() {
        await _supabase.auth.signOut();
        currentUser = null;
        trades = [];
        checkAuth();
    }

    function toggleAuthMode() {
        const login = document.getElementById('loginForm');
        const signup = document.getElementById('signupForm');
        const errorMsg = document.getElementById('errorMessage');
        const successMsg = document.getElementById('successMessage');
        
        errorMsg.style.display = 'none';
        successMsg.style.display = 'none';
        
        if (login.style.display === 'none') {
            login.style.display = 'block';
            signup.style.display = 'none';
        } else {
            login.style.display = 'none';
            signup.style.display = 'block';
        }
    }

    function showError(message) {
        const el = document.getElementById('errorMessage');
        el.textContent = message;
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 5000);
    }

    function showSuccess(message) {
        const el = document.getElementById('successMessage');
        el.textContent = message;
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 5000);
    }

    let trades = [];
    let customInstruments = JSON.parse(localStorage.getItem('customInstruments')) || ["XAUUSD", "UK100", "GER40", "BTC", "SPX", "NASDAQ"];
    let customStrategies = JSON.parse(localStorage.getItem('customStrategies')) || ["Breakout", "Retest", "Trend", "Scalp"];
    let equityChart, drawdownChart, distributionChart, weekdayChart, strategyPLChart, heatmapChart;
    let currentViewDate = new Date();
    let selectedDateFilter = null;

    function validateNumber(input) { input.value = input.value.replace(/[^0-9.\-]/g, ''); }

    function animateValue(id, start, end, duration, isCurrency = false, isPercent = false, suffix = "") {
        const obj = document.getElementById(id);
        if (!obj) return;
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            const val = progress * (end - start) + start;
            if (isCurrency) obj.textContent = '$' + val.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            else if (isPercent) obj.textContent = val.toFixed(1) + '%';
            else obj.textContent = val.toFixed(isCurrency ? 2 : 1) + suffix;
            if (progress < 1) window.requestAnimationFrame(step);
        };
        window.requestAnimationFrame(step);
    }

async function fetchTrades() {
        if (!currentUser) return;
        const { data, error } = await _supabase.from('trades').select('*').eq('user_id', currentUser.id);
        if (error) console.error('Error:', error);
        else { trades = data || []; refreshApp(); }
    }

 window.addEventListener('load', () => {
        checkAuth();
        const savedBalance = localStorage.getItem('initialBalance');
        if (savedBalance) document.getElementById('initialBalanceInput').value = savedBalance;
        setupDragAndDrop();
    });

    function setupDragAndDrop() {
        const dropArea = document.getElementById('screenshot');
        dropArea.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.style.borderColor = "#00f2ff"; });
        dropArea.addEventListener('dragleave', () => dropArea.style.borderColor = "#3d4651");
        dropArea.addEventListener('drop', (e) => {
            e.preventDefault(); dropArea.style.borderColor = "#3d4651";
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (ev) => { dropArea.value = ev.target.result; };
                reader.readAsDataURL(file);
            }
        });
    }

    function populateLists() {
        document.getElementById('instrument').innerHTML = customInstruments.map(i => `<option value="${i}">${i}</option>`).join('');
        document.getElementById('strategy').innerHTML = customStrategies.map(s => `<option value="${s}">${s}</option>`).join('');
        const filter = document.getElementById('historyInstrumentFilter');
        filter.innerHTML = `<option value="ALL">All Instruments</option>` + customInstruments.map(i => `<option value="${i}">${i}</option>`).join('');
    }

    function refreshApp() { renderCalendar(); updateStatsAndTable(); resetForm(); }

  function updateStatsAndTable() {
    // 1. Grundlegende Daten laden
    const initialBalance = parseFloat(document.getElementById('initialBalanceInput').value) || 0;
    localStorage.setItem('initialBalance', initialBalance);
    const instrumentFilter = document.getElementById('historyInstrumentFilter').value;

    // 2. Filtern der Trades
    let filtered = trades.filter(t => {
        const matchesTime = selectedDateFilter ? (t.date === selectedDateFilter) : (new Date(t.date).getMonth() === currentViewDate.getMonth() && new Date(t.date).getFullYear() === currentViewDate.getFullYear());
        const matchesInstrument = (instrumentFilter === 'ALL' || t.instrument === instrumentFilter);
        return matchesTime && matchesInstrument;
    });

    let traderAllTrades = trades;
    const totalNetPL = traderAllTrades.reduce((sum, t) => sum + Number(t.pl), 0);
    
    // 3. Stats & Profit Factor Berechnung
    animateValue('currentEquity', 0, initialBalance + totalNetPL, 800, true);
    
    const wins = filtered.filter(t => t.result === 'WIN');
    const losses = filtered.filter(t => t.result === 'LOSS'); // Neu f√ºr Avg Loss
    
    const viewPL = filtered.reduce((sum, t) => sum + Number(t.pl), 0);
    const winRateVal = filtered.length > 0 ? (wins.length / filtered.length) * 100 : 0;
    
    const totalWinAmount = filtered.filter(t => Number(t.pl) > 0).reduce((sum, t) => sum + Number(t.pl), 0);
    const totalLossAmount = Math.abs(filtered.filter(t => Number(t.pl) < 0).reduce((sum, t) => sum + Number(t.pl), 0));
    
    // --- NEU: DURCHSCHNITTE BERECHNEN ---
    const avgWinVal = wins.length > 0 ? (totalWinAmount / wins.length) : 0;
    const avgLossVal = losses.length > 0 ? (totalLossAmount / losses.length) : 0;

    // Werte animieren (wie bei deinen anderen Stats)
    if(document.getElementById('avgWin')) animateValue('avgWin', 0, avgWinVal, 800, true);
    if(document.getElementById('avgLoss')) animateValue('avgLoss', 0, avgLossVal, 800, true);
    
    // Diagramm zeichnen
    if (typeof renderAvgChart === "function") renderAvgChart(avgWinVal, avgLossVal);
    // ------------------------------------

    let pf = totalLossAmount === 0 ? (totalWinAmount > 0 ? totalWinAmount : 0) : (totalWinAmount / totalLossAmount);

    animateValue('totalTrades', 0, filtered.length, 800);
    animateValue('winRate', 0, winRateVal, 800, false, true);
    animateValue('totalPL', 0, viewPL, 800, true);
    if(document.getElementById('profitFactor')) animateValue('profitFactor', 0, pf, 800);

    // 4. Glow Effekt
    const plCard = document.getElementById('card-pl');
    if (plCard) {
        plCard.classList.remove('glow-win', 'glow-loss');
        if (viewPL > 0) plCard.classList.add('glow-win');
        else if (viewPL < 0) plCard.classList.add('glow-loss');
    }

    // 5. Durchschnittlicher R-Multiplikator
    const totalR = filtered.reduce((sum, t) => sum + (Number(t.pl) / (parseFloat(t.risk) || 1)), 0);
    const avgRElement = document.getElementById('avgR');
    if (avgRElement) avgRElement.textContent = (filtered.length > 0 ? (totalR / filtered.length).toFixed(2) : '0.0') + 'R';
    
    // 6. SORTIERUNG & PAGINATION
    const sorted = filtered.sort((a,b) => new Date(b.date + ' ' + (b.time || '00:00')) - new Date(a.date + ' ' + (a.time || '00:00')));
    const totalPages = Math.ceil(sorted.length / tradesPerPage) || 1;
    if (currentPage > totalPages) currentPage = totalPages;
    const start = (currentPage - 1) * tradesPerPage;
    const paginatedTrades = sorted.slice(start, start + tradesPerPage);

    if(document.getElementById('pageInfo')) document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
    if(document.getElementById('tradeCounter')) document.getElementById('tradeCounter').textContent = `Showing ${countStart = sorted.length > 0 ? start + 1 : 0}-${countEnd = Math.min(start + tradesPerPage, sorted.length)} of ${sorted.length} Trades`;
    if(document.getElementById('prevPage')) document.getElementById('prevPage').disabled = (currentPage === 1);
    if(document.getElementById('nextPage')) document.getElementById('nextPage').disabled = (currentPage === totalPages || sorted.length === 0);

    // 7. Tabelle rendern
    document.getElementById('tradesBody').innerHTML = paginatedTrades.map(t => {
        const rMult = (Number(t.pl) / (parseFloat(t.risk) || 1)).toFixed(2);
        const rowClass = Number(t.pl) >= 0 ? 'row-win' : 'row-loss';
        return `<tr class="${rowClass}">
            <td><input type="checkbox" class="trade-checkbox" value="${t.id}"></td>
            <td title="Time: ${t.time || '--:--'}" style="cursor: help; text-decoration: underline dotted rgba(255,255,255,0.3);">${t.date}</td>
            <td>${t.instrument}</td>
            <td>${t.strategy || '-'}</td>
            <td>${t.direction}</td>
            <td>${t.entry}/${t.exit}</td>
            <td class="${Number(t.pl) >= 0 ? 'win' : 'loss'}">$${Number(t.pl).toFixed(2)}</td>
            <td class="${Number(rMult) >= 0 ? 'win' : 'loss'}">${rMult}R</td>
            <td title="${t.notes || ''}" style="cursor:help; font-weight:bold;">${t.mistake}</td>
            <td>${t.screenshot ? `<a href="#" onclick="showPreview('${t.screenshot}'); return false;">üñºÔ∏è</a>` : '-'}</td>
            <td>
                <button class="btn-sm edit-btn" onclick="prepareEdit('${t.id}')">Edit</button>
                <button class="btn-sm del-btn" onclick="deleteTradeDB('${t.id}')">Del</button>
            </td>
        </tr>`;
    }).join('');

    if (typeof updateCharts === "function") updateCharts(traderAllTrades);
}

    function updateCharts(chartTrades) {
        const initialBalance = parseFloat(document.getElementById('initialBalanceInput').value) || 0;
        const chrono = [...chartTrades].sort((a,b) => new Date(a.date + ' ' + a.time) - new Date(b.date + ' ' + b.time));
        let runningEquity = initialBalance, peak = initialBalance;
        const equityData = [initialBalance], drawdownData = [0];
        chrono.forEach(t => { runningEquity += Number(t.pl); equityData.push(runningEquity); if (runningEquity > peak) peak = runningEquity; drawdownData.push(runningEquity - peak); });

        if (equityChart) equityChart.destroy();
        equityChart = new Chart(document.getElementById('equityChart').getContext('2d'), { type: 'line', data: { labels: [0, ...chrono.map((_,i)=>i+1)], datasets: [{ label: 'Equity', data: equityData, borderColor: '#00f2ff', fill: true, backgroundColor: 'rgba(0, 242, 255, 0.05)', tension: 0.3, pointRadius: 2 }] }, options: { maintainAspectRatio: false, plugins: { title: { display: true, text: 'EQUITY CURVE', color: '#8892b0' }, legend: {display:false} } } });
        if (drawdownChart) drawdownChart.destroy();
        drawdownChart = new Chart(document.getElementById('drawdownChart').getContext('2d'), { type: 'line', data: { labels: [0, ...chrono.map((_,i)=>i+1)], datasets: [{ label: 'Drawdown', data: drawdownData, borderColor: '#ff4a68', fill: true, backgroundColor: 'rgba(255, 74, 104, 0.05)', tension: 0.3, pointRadius: 0 }] }, options: { maintainAspectRatio: false, plugins: { title: { display: true, text: 'DRAWDOWN ($)', color: '#8892b0' }, legend: {display:false} } } });
        const stratMap = {}; chartTrades.forEach(t => { const s = t.strategy || 'Other'; stratMap[s] = (stratMap[s] || 0) + Number(t.pl); });
        if (strategyPLChart) strategyPLChart.destroy();
        strategyPLChart = new Chart(document.getElementById('strategyPLChart').getContext('2d'), { type: 'bar', data: { labels: Object.keys(stratMap), datasets: [{ data: Object.values(stratMap), backgroundColor: Object.values(stratMap).map(v => v >= 0 ? '#00f2ff' : '#ff4a68') }] }, options: { maintainAspectRatio: false, plugins: { title: { display: true, text: 'BY STRATEGY', color: '#8892b0' }, legend: {display:false} } } });
        if (distributionChart) distributionChart.destroy();
        distributionChart = new Chart(document.getElementById('distributionChart').getContext('2d'), { type: 'bar', data: { labels: ['Plan', 'FOMO', 'Early', 'Revenge', 'Late'], datasets: [{ data: ['PLAN', 'FOMO', 'EARLY_EXIT', 'REVENGE', 'LATE_ENTRY'].map(tag => chartTrades.filter(t=>t.mistake===tag).length), backgroundColor: '#764ba2' }] }, options: { maintainAspectRatio: false, plugins: { title: { display: true, text: 'TAGS', color: '#8892b0' }, legend: {display:false} } } });
        const dD = [0,0,0,0,0,0,0]; chartTrades.forEach(t => { dD[new Date(t.date).getDay()] += Number(t.pl); });
        if (weekdayChart) weekdayChart.destroy();
        weekdayChart = new Chart(document.getElementById('weekdayChart').getContext('2d'), { type: 'bar', data: { labels: ['S','M','T','W','T','F','S'], datasets: [{ data: dD, backgroundColor: dD.map(v => v >= 0 ? '#00ffaa' : '#ff4a68') }] }, options: { maintainAspectRatio: false, plugins: { title: { display: true, text: 'WEEKDAY P/L', color: '#8892b0' }, legend: {display:false} } } });
    
		createHeatmap(chartTrades);
	}

    document.getElementById('tradeForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const editId = document.getElementById('editId').value;
        if (!currentUser) return alert("Please login first!");
        let rawPL = Math.abs(parseFloat(document.getElementById('pl').value)) || 0;
        const result = document.getElementById('result').value;
        
// Visuelles Feedback je nach Result
const flashOverlay = document.getElementById('flashOverlay');
const container = document.querySelector('.container');

if (result === 'WIN') {
    // Gr√ºner Flash
    flashOverlay.classList.add('flash-win');
    container.classList.add('shake-win');
    setTimeout(() => {
        flashOverlay.classList.remove('flash-win');
        container.classList.remove('shake-win');
    }, 300);
} else if (result === 'LOSS') {
    // Roter Flash
    flashOverlay.classList.add('flash-loss');
    container.classList.add('shake-loss');
    setTimeout(() => {
        flashOverlay.classList.remove('flash-loss');
        container.classList.remove('shake-loss');
    }, 300);
} else if (result === 'BE') {
    // Lila Flash
    flashOverlay.classList.add('flash-be');
    container.classList.add('shake-be');
    setTimeout(() => {
        flashOverlay.classList.remove('flash-be');
        container.classList.remove('shake-be');
    }, 250);
}

        const plValue = result === 'LOSS' ? -rawPL : (result === 'BE' ? 0 : rawPL);
        const data = { 
            user_id: currentUser.id,
            date: document.getElementById('date').value, time: document.getElementById('time').value, instrument: document.getElementById('instrument').value, 
            strategy: document.getElementById('strategy').value, direction: document.getElementById('direction').value, entry: document.getElementById('entry').value, 
            exit: document.getElementById('exit').value, result: result, pl: plValue, 
            risk: document.getElementById('risk').value || "100", mistake: document.getElementById('mistake').value, screenshot: document.getElementById('screenshot').value, 
            notes: document.getElementById('notes').value
        };
        if (editId) await _supabase.from('trades').update(data).eq('id', editId);
        else await _supabase.from('trades').insert([data]);
        fetchTrades();
    });

    function resetForm() { 
        document.getElementById('tradeForm').reset(); document.getElementById('editId').value = ""; 
        document.getElementById('submitBtn').textContent = "Save Trade";
        const now = new Date(); document.getElementById('date').value = now.toISOString().split('T')[0];
        document.getElementById('time').value = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
        populateLists(); 
    }

    function renderCalendar() {
    const grid = document.getElementById('calendarGrid');
    grid.innerHTML = ''; 
    const year = currentViewDate.getFullYear(), month = currentViewDate.getMonth();
    document.getElementById('calendarMonth').textContent = new Intl.DateTimeFormat('en-US', { month: 'long', year: 'numeric' }).format(currentViewDate);
    const daysInMonth = new Date(year, month + 1, 0).getDate(), firstDayIndex = new Date(year, month, 1).getDay();
    ['S','M','T','W','T','F','S'].forEach(l => grid.innerHTML += `<div class="calendar-day-label">${l}</div>`);
    for (let i = 0; i < firstDayIndex; i++) grid.innerHTML += `<div></div>`;
    for (let d = 1; d <= daysInMonth; d++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        const dayTrades = trades.filter(t => t.date === dateStr);
			
            const dayPL = dayTrades.reduce((sum, t) => sum + Number(t.pl), 0);
            const dayEl = document.createElement('div');
            dayEl.className = `calendar-day ${dayPL > 0 ? 'day-win' : (dayPL < 0 ? 'day-loss' : '')} ${selectedDateFilter === dateStr ? 'selected' : ''}`;
            dayEl.innerHTML = `<span class="day-num">${d}</span><span class="day-pl">${dayPL !== 0 ? dayPL.toFixed(0) : ''}</span>`;
            dayEl.onclick = () => { selectedDateFilter = (selectedDateFilter === dateStr) ? null : dateStr; renderCalendar(); updateStatsAndTable(); };
            grid.appendChild(dayEl);
        }
    }

    function prepareEdit(id) {
        const t = trades.find(tr => tr.id === id);
        document.getElementById('date').value = t.date; document.getElementById('time').value = t.time; 
        document.getElementById('instrument').value = t.instrument; document.getElementById('strategy').value = t.strategy;
        document.getElementById('direction').value = t.direction; document.getElementById('entry').value = t.entry; 
        document.getElementById('exit').value = t.exit; document.getElementById('result').value = t.result; 
        document.getElementById('pl').value = Math.abs(t.pl); document.getElementById('risk').value = t.risk; 
        document.getElementById('mistake').value = t.mistake; document.getElementById('screenshot').value = t.screenshot; 
        document.getElementById('notes').value = t.notes; document.getElementById('editId').value = t.id; 
        document.getElementById('submitBtn').textContent = "Update Trade";
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

 async function processBulkImport() {
    if (!currentUser) return alert("Please login first!");
	
        const area = document.getElementById('importArea'), raw = area.value.trim(); 
        if(!raw) return alert("Please paste data!");
        
        const lines = raw.split('\n');
        const newTrades = [];
        
        // Check if it's TradingView format (contains "Realized P&L" header)
        const isTradingViewFormat = lines[0].includes('Realized P&L');
        
        if (isTradingViewFormat) {
            // TradingView Format Processing
            for(let i = 1; i < lines.length; i++) { // Skip header
                const line = lines[i].trim();
                if (!line) continue;
                
                const parts = line.split(',');
                if (parts.length < 6) continue;
                
                // Extract date and time from first column: "2026-01-23 17:10:50"
                const dateTime = parts[0].split(' ');
                const date = dateTime[0]; // "2026-01-23"
                const time = dateTime[1].substring(0, 5); // "17:10"
                
                // Extract P/L
                const pl = parseFloat(parts[3]);
                
                // Extract action details from last column
                const action = parts.slice(5).join(','); // Rejoin in case there are commas in action
                
                // Extract direction (long or short)
                const isLong = action.toLowerCase().includes('close long');
                const direction = isLong ? 'LONG' : 'SHORT';
                
                // Extract symbol: "BLACKBULL:GER40" -> "GER40" or "BROKER:SYMBOL" -> "SYMBOL"
                // Matches any broker prefix followed by colon, or just the symbol itself
                const symbolMatch = action.match(/symbol\s+(?:\w+:)?(\w+)/i);
                const instrument = symbolMatch ? symbolMatch[1] : 'UNKNOWN';
                
                // Extract exit price: "at price 10135.4"
                const priceMatch = action.match(/at price ([\d.]+)/);
                const exitPrice = priceMatch ? parseFloat(priceMatch[1]).toString() : '0';
                
                // Extract avg entry price: "Position AVG Price was 10145.300000"
                const avgPriceMatch = action.match(/AVG Price was ([\d.]+)/);
                const entryPrice = avgPriceMatch ? parseFloat(avgPriceMatch[1]).toString() : '0';
                
                newTrades.push({ 
                    user_id: currentUser.id,
                    date: date,
                    time: time,
                    instrument: instrument,
                    strategy: 'TradingView',
                    direction: direction,
                    entry: entryPrice,
                    exit: exitPrice,
                    pl: pl,
                    result: pl >= 0 ? 'WIN' : 'LOSS',
                    risk: "100",
                    mistake: "PLAN",
                    screenshot: "",
                    notes: `Imported from TradingView`,
                    
                });
            }
        } else {
            // Original Tab-separated format
            const months = {Jan:'01',Feb:'02',Mar:'03',Apr:'04',May:'05',Jun:'06',Jul:'07',Aug:'08',Sep:'09',Oct:'10',Nov:'11',Dec:'12'};
            for(let line of lines) {
                const parts = line.split('\t').map(p => p.trim());
                if(parts.length >= 7) {
                    const dateParts = parts[2].split(' ');
                   newTrades.push({ 
                        user_id: currentUser.id,
                        date: `${dateParts[2]}-${months[dateParts[1]]}-${dateParts[0].padStart(2, '0')}`,
                        time: dateParts[3].substring(0, 5), 
                        instrument: parts[0], 
                        strategy: 'Imported', 
                        direction: parts[1].toUpperCase().includes('BUY') ? 'LONG' : 'SHORT', 
                        entry: parts[3], 
                        exit: parts[4], 
                        pl: parseFloat(parts[6]), 
                        result: parseFloat(parts[6]) >= 0 ? 'WIN' : 'LOSS', 
                        risk: "100", 
                        mistake: "PLAN",
                        screenshot: "",
                        notes: "",
                       
                    });
                }
            }
        }
        
        if(newTrades.length > 0) { 
            await _supabase.from('trades').insert(newTrades); 
            area.value = ""; 
            alert(`‚úÖ Successfully imported ${newTrades.length} trades!`);
            fetchTrades(); 
        } else {
            alert("‚ùå No valid trades found. Please check the format.");
        }
    }

    function changeMonth(val) { currentViewDate.setMonth(currentViewDate.getMonth() + val); selectedDateFilter = null; renderCalendar(); updateStatsAndTable(); }
	
	function createHeatmap(chartTrades) {
    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const hours = Array.from({length: 24}, (_, i) => i);
    
    // Grid initialisieren
    const heatmapData = {};
    days.forEach((_, dayIdx) => {
        hours.forEach(hour => {
            heatmapData[`${dayIdx}-${hour}`] = { pl: 0, count: 0 };
        });
    });
    
    // Trade Daten sammeln
    chartTrades.forEach(t => {
        if (!t.time) return;
        const date = new Date(t.date + ' ' + t.time);
        const dayIdx = date.getDay();
        const hour = date.getHours();
        const key = `${dayIdx}-${hour}`;
        
        if (heatmapData[key]) {
            heatmapData[key].pl += Number(t.pl);
            heatmapData[key].count += 1;
        }
    });
    
    // Matrix f√ºr Chart erstellen
    const matrixData = [];
    days.forEach((_, dayIdx) => {
        hours.forEach(hour => {
            const key = `${dayIdx}-${hour}`;
            const cell = heatmapData[key];
            
            if (cell.count > 0) {
                matrixData.push({
                    x: hour,
                    y: dayIdx,
                    v: cell.pl / cell.count, // Durchschnitt
                    count: cell.count,
                    totalPL: cell.pl
                });
            }
        });
    });
    
    // Min/Max f√ºr Farben
    const values = matrixData.map(d => d.v);
    const absMax = Math.max(...values.map(Math.abs), 1);
    
    // Chart erstellen
    if (heatmapChart) heatmapChart.destroy();
    
    heatmapChart = new Chart(document.getElementById('heatmapChart').getContext('2d'), {
        type: 'bubble',
        data: {
            datasets: [{
                label: 'Avg P/L',
                data: matrixData,
                backgroundColor: matrixData.map(d => {
                    const intensity = Math.abs(d.v) / absMax;
                    if (d.v > 0) return `rgba(0, 255, 170, ${0.3 + intensity * 0.6})`;
                    if (d.v < 0) return `rgba(255, 74, 104, ${0.3 + intensity * 0.6})`;
                    return 'rgba(100, 100, 100, 0.3)';
                }),
                borderColor: matrixData.map(d => d.v > 0 ? '#00ffaa' : '#ff4a68'),
                borderWidth: 1,
                radius: matrixData.map(d => 8 + Math.min(d.count * 3, 15))
            }]
        },
        options: {
            maintainAspectRatio: false,
            scales: {
                x: {
                    title: { display: true, text: 'Hour of Day', color: '#8892b0' },
                    ticks: { 
                        color: '#8892b0',
                        callback: (val) => val + ':00'
                    },
                    grid: { color: 'rgba(255,255,255,0.05)' },
                    min: 0,
                    max: 23
                },
                y: {
                    title: { display: true, text: 'Day of Week', color: '#8892b0' },
                    ticks: { 
                        color: '#8892b0',
                        callback: (val) => days[val]
                    },
                    grid: { color: 'rgba(255,255,255,0.05)' },
                    min: 0,
                    max: 6
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'PERFORMANCE HEATMAP (Day vs Hour)',
                    color: '#00f2ff',
                    font: { size: 14, weight: 'bold' }
                },
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        title: (items) => {
                            const d = items[0].raw;
                            return `${days[d.y]} at ${d.x}:00`;
                        },
                        label: (item) => {
                            const d = item.raw;
                            return [
                                `Avg P/L: $${d.v.toFixed(2)}`,
                                `Total P/L: $${d.totalPL.toFixed(2)}`,
                                `Trades: ${d.count}`
                            ];
                        }
                    }
                }
            }
        }
    });
}
	
    function showPreview(url) { const p = document.getElementById('screenshot-preview-popup'); p.src = url; p.style.display = 'block'; }
    function hidePreview() { const p = document.getElementById('screenshot-preview-popup'); p.style.display = 'none'; p.src = ''; }
    function addNewInstrument() { const v = prompt("New Instrument:").toUpperCase(); if(v) { customInstruments.push(v); localStorage.setItem('customInstruments', JSON.stringify(customInstruments)); populateLists(); } }
	function addNewStrategy() { const v = prompt("New Strategy:"); if(v) { customStrategies.push(v); localStorage.setItem('customStrategies', JSON.stringify(customStrategies)); populateLists(); } }
    
	
	function removeInstrument() {
    const selectedInstrument = document.getElementById('instrument').value;
    
    // Check ob das Instrument in Trades verwendet wird
    const usedInTrades = trades.filter(t => t.instrument === selectedInstrument).length;
    
    if (usedInTrades > 0) {
        if (!confirm(` WARNING!\n\nThis instrument "${selectedInstrument}" is used in ${usedInTrades} trade(s).\n\nDeleting it will NOT delete your trades, but the instrument won't appear in the dropdown anymore.\n\nAre you sure you want to remove it?`)) {
            return;
        }
    } else {
        if (!confirm(`Remove instrument "${selectedInstrument}"?`)) {
            return;
        }
    }
    
    // Verhindere dass das letzte Instrument gel√∂scht wird
    if (customInstruments.length <= 1) {
        alert(' Cannot delete the last instrument!\n\nYou need at least one instrument in the list.');
        return;
    }
    
    customInstruments = customInstruments.filter(i => i !== selectedInstrument);
    localStorage.setItem('customInstruments', JSON.stringify(customInstruments));
    populateLists();
}

function removeStrategy() {
    const selectedStrategy = document.getElementById('strategy').value;
    
    // Check ob die Strategy in Trades verwendet wird
    const usedInTrades = trades.filter(t => t.strategy === selectedStrategy).length;
    
    if (usedInTrades > 0) {
        if (!confirm(` WARNING!\n\nThis strategy "${selectedStrategy}" is used in ${usedInTrades} trade(s).\n\nDeleting it will NOT delete your trades, but the strategy won't appear in the dropdown anymore.\n\nAre you sure you want to remove it?`)) {
            return;
        }
    } else {
        if (!confirm(`Remove strategy "${selectedStrategy}"?`)) {
            return;
        }
    }
    
    // Verhindere dass die letzte Strategy gel√∂scht wird
    if (customStrategies.length <= 1) {
        alert(' Cannot delete the last strategy!\n\nYou need at least one strategy in the list.');
        return;
    }
    
    customStrategies = customStrategies.filter(s => s !== selectedStrategy);
    localStorage.setItem('customStrategies', JSON.stringify(customStrategies));
    populateLists();
}
	
    async function deleteTradeDB(id) { if(confirm('Delete?')) { await _supabase.from('trades').delete().eq('id', id); fetchTrades(); } }
    async function deleteAllTrades() { if(confirm('Delete ALL?')) { await _supabase.from('trades').delete().not('id', 'is', null); fetchTrades(); } }
	
 function exportToCSV() { let csv = 'Date,Instrument,Strategy,Direction,Entry,Exit,PL,Result\n' + trades.map(t => `${t.date},${t.instrument},${t.strategy},${t.direction},${t.entry},${t.exit},${t.pl},${t.result}`).join('\n'); const b = new Blob([csv], {type:'text/csv'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download='Journal.csv'; a.click(); }

async function downloadPersonalizedEA() {
    let userId = "";

    // 1. Versuch: Aus der Anzeige lesen
    const displayElement = document.getElementById('userIdDisplay');
    if (displayElement) {
        userId = displayElement.textContent.trim();
    }

    // 2. Versuch: Falls Anzeige noch l√§dt, interne Variable pr√ºfen
    if (!userId || userId.includes("Lade") || userId.length < 10) {
        if (typeof _currentUserId !== 'undefined' && _currentUserId) {
            userId = _currentUserId;
        }
    }

    // 3. Versuch: Direkt von Supabase Auth
    if (!userId || userId.length < 10) {
        try {
            const { data: { session } } = await _supabase.auth.getSession();
            if (session) userId = session.user.id;
        } catch (e) {}
    }

    if (!userId || userId.includes("Lade") || userId.length < 10) {
        alert("ID noch nicht bereit. Bitte warten Sie kurz, bis das Journal geladen ist.");
        return;
    }

    // Das EA Template basierend auf der stabilen Final_EA Version (V5 Logik)
    const eaCode = `//+------------------------------------------------------------------+
//|                                     JournalSync_Pro_Connector.mq5|
//|                                     User-ID: ${userId}            |
//+------------------------------------------------------------------+
#property copyright "Trading Journal Pro"
#property version   "5.60"
#property strict
#property description "Automatischer Sync f√ºr Ihr Trading Journal"

input string InpUserID      = "${userId}"; 
input int    InpInterval    = 5; 

string InpSupabaseUrl = "https://nrmivhzvwqpnwedvkbbz.supabase.co"; 
string InpApiKey      = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ybWl2aHp2d3FwbndlZHZrYmJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3MjgzMTIsImV4cCI6MjA4NDMwNDMxMn0.DmpCTBurgMHoba3KpsjRCEOqltV4-bL06ezPr7gAbyg";

int OnInit() {
   Print(">>> Auto-Sync PRO Aktiviert f√ºr ID: ", InpUserID);
   EventSetTimer(InpInterval * 60); 
   SyncNow(); 
   return(INIT_SUCCEEDED);
}

void OnDeinit(const int reason) { EventKillTimer(); }
void OnTimer() { SyncNow(); }

void SyncNow() {
   // Synchronisiert die letzten 30 Tage
   if(!HistorySelect(TimeCurrent() - (30 * 86400), TimeCurrent())) return;
   
   int totalDeals = HistoryDealsTotal();
   for(int i = 0; i < totalDeals; i++) {
      ulong ticket = HistoryDealGetTicket(i);
      if(ticket <= 0) continue;

      double profit = HistoryDealGetDouble(ticket, DEAL_PROFIT);
      double swap = HistoryDealGetDouble(ticket, DEAL_SWAP);
      double comm = HistoryDealGetDouble(ticket, DEAL_COMMISSION);
      double totalPL = profit + swap + comm;
      
      // Nur abgeschlossene Trades (Profit != 0)
      if(totalPL == 0) continue; 

      string symbol = HistoryDealGetString(ticket, DEAL_SYMBOL);
      datetime time = (datetime)HistoryDealGetInteger(ticket, DEAL_TIME);
      double exitPrice = HistoryDealGetDouble(ticket, DEAL_PRICE);
      long type = HistoryDealGetInteger(ticket, DEAL_TYPE);
      
      string dateStr = TimeToString(time, TIME_DATE);
      StringReplace(dateStr, ".", "-");

      string json = "{\\"p_user_id\\":\\""+InpUserID+"\\","+
                    "\\"p_date\\":\\""+dateStr+"\\","+
                    "\\"p_time\\":\\""+TimeToString(time, TIME_MINUTES)+"\\","+
                    "\\"p_instrument\\":\\""+symbol+"\\","+
                    "\\"p_strategy\\":\\"Auto-Sync-Pro\\","+
                    "\\"p_direction\\":\\""+((type==DEAL_TYPE_SELL)?"SHORT":"LONG")+"\\","+
                    "\\"p_entry\\":"+DoubleToString(exitPrice, 2)+","+
                    "\\"p_exit\\":"+DoubleToString(exitPrice, 2)+","+
                    "\\"p_pl\\":"+DoubleToString(totalPL, 2)+","+
                    "\\"p_result\\":\\""+((totalPL>=0)?"WIN":"LOSS")+"\\","+
                    "\\"p_notes\\":\\"Automatischer MT5 Import\\","+
                    "\\"p_mt5_id\\":\\""+IntegerToString(ticket)+"\\","+
                    "\\"p_status\\":\\"Closed\\"}";

      char postData[], resultData[]; string resultHeaders;
      StringToCharArray(json, postData, 0, StringLen(json));
      
      WebRequest("POST", InpSupabaseUrl + "/rest/v1/rpc/upload_trade", 
                 "Content-Type: application/json\\r\\napikey: " + InpApiKey + "\\r\\nAuthorization: Bearer " + InpApiKey + "\\r\\n", 
                 5000, postData, resultData, resultHeaders);
   }
}
`;

    // Download-Vorgang
    const blob = new Blob([eaCode], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'JournalSync_Pro.mq5';
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
}

function toggleSelectAll(source) {
    const checkboxes = document.querySelectorAll('.trade-checkbox');
    checkboxes.forEach(cb => cb.checked = source.checked);
}

async function deleteSelectedTrades() {
    const checkboxes = document.querySelectorAll('.trade-checkbox:checked');
    const idsToDelete = Array.from(checkboxes).map(cb => cb.value);
    
    if (idsToDelete.length === 0) {
        alert("Bitte w√§hle zuerst Trades aus.");
        return;
    }
    
    if (confirm(`${idsToDelete.length} Trades wirklich l√∂schen?`)) {
        const { error } = await _supabase.from('trades').delete().in('id', idsToDelete);
        if (error) {
            alert("Fehler beim L√∂schen: " + error.message);
        } else {
            // Checkbox "Alle ausw√§hlen" wieder zur√ºcksetzen
            document.getElementById('selectAll').checked = false;
            fetchTrades(); // Tabelle neu laden
        }
    }
}

function changePage(delta) {
    currentPage += delta;
    updateStatsAndTable();

    // Wir suchen erst die Sektion, dann die Tabelle, dann die √úberschrift
    const scrollTarget = document.querySelector('.history-section') || 
                         document.querySelector('.trades-table') || 
                         document.querySelector('h2');

    if (scrollTarget) {
        // Berechne die Position mit einem kleinen Offset (50px) nach oben, 
        // damit die √úberschrift nicht am Rand klebt
        const offset = 50;
        const elementPosition = scrollTarget.getBoundingClientRect().top;
        const offsetPosition = elementPosition + window.pageYOffset - offset;

        window.scrollTo({
            top: offsetPosition,
            behavior: 'smooth'
        });
    }
}

let avgChartInstance = null;
function renderAvgChart(win, loss) {
    const ctx = document.getElementById('avgChart');
    if (!ctx) return;
    if (avgChartInstance) avgChartInstance.destroy();
    
    avgChartInstance = new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: {
            labels: ['Avg Win', 'Avg Loss'],
            datasets: [{
                label: 'Betrag $',
                data: [win, loss],
                backgroundColor: ['#00ff88', '#ff4444'],
                borderRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, grid: { color: '#333' } } }
        }
    });
}
</script>
<div id="flashOverlay" class="flash-overlay"></div>

</div> <!-- Ende mainApp 
Ende mainApp 
Ende mainApp 
Ende mainApp -->

</body>
</html>
